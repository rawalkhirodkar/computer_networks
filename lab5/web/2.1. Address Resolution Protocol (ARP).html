<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0039)http://linux-ip.net/html/ether-arp.html -->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>2.1.&nbsp;Address Resolution Protocol (ARP)</title><link rel="stylesheet" href="./2.1. Address Resolution Protocol (ARP)_files/linux-ip.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.69.0"><meta name="keywords" content="linux, ip, iproute2, ifconfig, firewall, ARP, NAT, route, routing, route selection, routing selection, network administration"><link rel="start" href="http://linux-ip.net/html/index.html" title="Guide to IP Layer Network Administration with Linux"><link rel="up" href="http://linux-ip.net/html/ch-ether.html" title="Chapter 2. Ethernet"><link rel="prev" href="http://linux-ip.net/html/ch-ether.html" title="Chapter 2. Ethernet"><link rel="next" href="http://linux-ip.net/html/ether-arp-proxy.html" title="2.2. Proxy ARP"><meta xmlns="http://www.w3.org/TR/xhtml1/transitional" name="generator" content="Experimental LDP.XSL $Revision: 1.2 $">
  <!-- Generated by LDP XSLT customization layer
      based on Norman Walsh's DocBook XSL stylesheets.
      More information at http://www.linuxdoc.org/ -->
  <style type="text/css"></style><script type="text/javascript" src="http://ads.dfgio.com/loader.js?client=topaz0003"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tbody><tr><th colspan="3" align="center">2.1.&nbsp;Address Resolution Protocol (ARP)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="http://linux-ip.net/html/ch-ether.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;2.&nbsp;Ethernet</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="http://linux-ip.net/html/ether-arp-proxy.html">Next</a></td></tr></tbody></table><hr></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ether-arp"></a>2.1.&nbsp;Address Resolution Protocol (ARP)</h2></div></div></div><p>
      Address Resolution Protocol (ARP) hovers in the shadows of most networks.
      Because of its simplicity, by comparison to higher layer protocols, ARP
      rarely intrudes upon the network administrator's routine.  All modern
      IP-capable operating systems provide support for ARP.  The uncommon
      alternative to ARP is static link-layer-to-IP mappings.
    </p><p>
      ARP defines the exchanges between network interfaces connected to an
      Ethernet media segment in order to map an IP address to a link layer
      address on demand.  Link layer addresses are hardware addresses (although
      <a href="http://linux-ip.net/html/tools-ip-link.html#tools-ip-link-set-address" title="B.3.7. Changing hardware or Ethernet broadcast address with
          ip link set">they are not immutable</a>)
      on Ethernet cards and IP addresses are logical addresses
      assigned to machines attached to the Ethernet.  Subsequently in this
      chapter, link layer addresses may be known by many different names:
      Ethernet addresses, Media Access Control (MAC) addresses, and even 
      hardware addresses.
      Disputably, the correct term from the kernel's perspective is "link
      layer address" because this address can be changed (on many Ethernet
      cards) via command line tools.  Nevertheless, these terms are not
      realistically distinct and can be used interchangeably.
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ether-arp-overview"></a>2.1.1.&nbsp;Overview of Address Resolution Protocol</h3></div></div></div><p>
        Address Resolution Protocol (ARP) exists solely to glue together the
        IP and Ethernet networking layers.  Since networking hardware
        such as switches, hubs, and bridges operate on Ethernet frames, they
        are unaware of the higher layer data carried by these frames
          <sup>[<a id="id2539996" href="http://linux-ip.net/html/ether-arp.html#ftn.id2539996">9</a>]</sup>.
        Similarly, IP layer devices, operating on IP packets need to be able
        to transmit their IP data on Ethernets.  ARP defines the
        conversation by which IP capable hosts can exchange mappings of
        their Ethernet and IP addressing.
      </p><a id="id2540014" class="indexterm"></a><a id="ether-arp-request"></a><p>
        ARP is used to locate the Ethernet address associated with a desired IP
        address.  When a machine has a packet bound for another IP on a locally
        connected Ethernet network, it will send a broadcast Ethernet frame
        containing an ARP request onto the Ethernet.  All machines with the same
        Ethernet broadcast address will receive this packet
        <sup>[<a id="id2540041" href="http://linux-ip.net/html/ether-arp.html#ftn.id2540041">10</a>]</sup>.
        If a machine receives the ARP request and it hosts the IP requested,
        it will respond with the link layer address on which it will receive
        packets for that IP address.
        <span class="foreignphrase"><em class="foreignphrase">N.B.</em></span>, the 
        <a href="http://linux-ip.net/html/ether-arp.html#ether-arp-flux-arpfilter" title="2.1.4.1. ARP flux prevention with arp_filter"><code class="constant">arp_filter</code>
        sysctl</a> will alter this behaviour
        somewhat.
      </p><a id="id2540079" class="indexterm"></a><a id="ether-arp-reply"></a><p>
        Once the requestor receives the response packet, it associates
        the MAC address and the IP address.  This information is stored in the
        <a href="http://linux-ip.net/html/ether-arp.html#ether-arp-cache" title="2.1.2. The ARP cache">arp cache</a>.  The arp cache
        can be manipulated with the
        <a href="http://linux-ip.net/html/tools-ip-neighbor.html" title="B.4. ip neighbor"><span><strong class="command">ip neighbor</strong></span></a>
        and
        <a href="http://linux-ip.net/html/tools-arp.html" title="B.1. arp"><span><strong class="command">arp</strong></span></a> commands.
        To learn how and when to manipulate the arp cache, see
        <a href="http://linux-ip.net/html/tools-arp.html" title="B.1. arp">Section&nbsp;B.1, “<span><strong class="command">arp</strong></span>”</a>.
      </p><p>
        In <a href="http://linux-ip.net/html/basic-reading.html#ex-basic-ping" title="Example 1.2. Testing reachability of a locally connected host with
          ping">Example&nbsp;1.2, “Testing reachability of a locally connected host with
          <span>ping</span>”</a>, we used <span><strong class="command">ping</strong></span> to
        test reachability of <code class="systemitem">masq-gw</code>.  Using a packet sniffer to capture
        the sequence of packets on the Ethernet as a result of <code class="systemitem">tristan</code>'s
        attempt to ping, provides an example of ARP <span class="foreignphrase"><em class="foreignphrase">in flagrante
        delicto</em></span>.  Consult the
        <a href="http://linux-ip.net/html/example-network-netmap.html" title="A.1. Example Network Map and General Notes">example network map</a> for a
        visual representation of the network layout in which this traffic
        occurs.
      </p><p>
        This is an archetypal conversation between two
        computers exchanging relevant hardware addressing in order that they 
        can pass IP packets, and is comprised of two Ethernet frames.
      </p><a id="id2540198" class="indexterm"></a><div class="example"><a id="ex-ether-arp-overview"></a><p class="title"><b>Example&nbsp;2.1.&nbsp;ARP conversation captured with tcpdump
          <sup>[<a id="id2540227" href="http://linux-ip.net/html/ether-arp.html#ftn.id2540227">11</a>]</sup>
        </b></p><table xmlns="http://www.w3.org/TR/xhtml1/transitional" border="0" bgcolor="#E0E0E0" width="90%"><tbody><tr><td><pre class="programlisting"><code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@masq-gw]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>tcpdump -ennqti eth0 \( arp or icmp \)</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">tcpdump: listening on eth0
0:80:c8:f8:4a:51 ff:ff:ff:ff:ff:ff 42: arp who-has 192.168.99.254 tell 192.168.99.35             <a id="ex-eao-request" href="http://linux-ip.net/html/ether-arp.html#ex-eao-request-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/1.png" alt="1" border="0"></a>
0:80:c8:f8:5c:73 0:80:c8:f8:4a:51 60: arp reply 192.168.99.254 is-at 0:80:c8:f8:5c:73            <a id="ex-eao-reply" href="http://linux-ip.net/html/ether-arp.html#ex-eao-reply-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/2.png" alt="2" border="0"></a>
0:80:c8:f8:4a:51 0:80:c8:f8:5c:73 98: 192.168.99.35 &gt; 192.168.99.254: icmp: echo request (DF)    <a id="ex-eao-ip" href="http://linux-ip.net/html/ether-arp.html#ex-eao-ip-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/3.png" alt="3" border="0"></a>
0:80:c8:f8:5c:73 0:80:c8:f8:4a:51 98: 192.168.99.254 &gt; 192.168.99.35: icmp: echo reply           <a id="ex-eao-ip2" href="http://linux-ip.net/html/ether-arp.html#ex-eao-ip-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/4.png" alt="4" border="0"></a></code>
        </pre></td></tr></tbody></table><div class="calloutlist"><table border="0" summary="Callout list"><tbody><tr><td width="5%" valign="top" align="left"><a id="ex-eao-request-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eao-request"><img src="./2.1. Address Resolution Protocol (ARP)_files/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><a id="id2540336" class="indexterm"></a><p>
                This broadcast Ethernet frame, identifiable by the
                destination Ethernet address with all bits set
                (ff:ff:ff:ff:ff:ff) contains an ARP request from <code class="systemitem">tristan</code>
                for IP address 192.168.99.254.  The request includes the
                source link layer address and the IP address of
                the requestor, which provides enough information for the
                owner of the IP address to reply with its link layer address.
              </p></td></tr><tr><td width="5%" valign="top" align="left"><a id="ex-eao-reply-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eao-reply"><img src="./2.1. Address Resolution Protocol (ARP)_files/2.png" alt="2" border="0"></a> </td><td valign="top" align="left"><a id="id2540378" class="indexterm"></a><p>
                The ARP reply from <code class="systemitem">masq-gw</code> includes its link layer address
                and declaration of ownership of the requested IP address.
                Note that the ARP reply is a unicast response to a broadcast
                request.  The payload of the ARP reply contains the link layer
                address mapping.
              </p><p>
                The machine which initiated the ARP request (<code class="systemitem">tristan</code>)
                now has enough information to encapsulate an IP packet in
                an Ethernet frame and forward it to the link layer address
                of the recipient (00:80:c8:f8:5c:73).
              </p></td></tr><tr><td width="5%" valign="top" align="left"><a id="ex-eao-ip-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eao-ip"><img src="./2.1. Address Resolution Protocol (ARP)_files/3.png" alt="3" border="0"></a> <a href="http://linux-ip.net/html/ether-arp.html#ex-eao-ip2"><img src="./2.1. Address Resolution Protocol (ARP)_files/4.png" alt="4" border="0"></a> </td><td valign="top" align="left">
                The final two packets in
                <a href="http://linux-ip.net/html/ether-arp.html#ex-ether-arp-overview" title="Example 2.1. ARP conversation captured with tcpdump
          
        ">Example&nbsp;2.1, “ARP conversation captured with tcpdump
          
        ”</a> display the link
                layer header and the encapsulated ICMP packets
                exchanged between these two hosts.  Examining the ARP
                cache on each of these hosts would reveal entries on
                each host for the other host's link layer address.
              </td></tr></tbody></table></div></div><p>
        This example is the commonest example of ARP traffic on an Ethernet.
        In summary, an ARP request is transmitted in a broadcast Ethernet
        frame.  The ARP reply is a unicast response, containing the desired
        information, sent to the requestor's link layer address.
      </p><p>
        An even rarer usage of ARP is gratuitous ARP, where a machine
        announces its ownership of an IP address on a media segment.  The
        <a href="http://linux-ip.net/html/tools-arping.html" title="B.2. arping"><span><strong class="command">arping</strong></span></a> utility
        can generate these gratuitous ARP frames.  Linux kernels will
        respect gratuitous ARP frames
        <sup>[<a id="id2540481" href="http://linux-ip.net/html/ether-arp.html#ftn.id2540481">12</a>]</sup>.
      </p><a id="id2540499" class="indexterm"></a><a id="id2540519" class="indexterm"></a><div class="example"><a id="ex-ether-arp-gratuitous"></a><p class="title"><b>Example&nbsp;2.2.&nbsp;Gratuitous ARP reply frames</b></p><table xmlns="http://www.w3.org/TR/xhtml1/transitional" border="0" bgcolor="#E0E0E0" width="90%"><tbody><tr><td><pre class="programlisting"><code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@tristan]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>arping -q -c 3 -A -I eth0 192.168.99.35</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@masq-gw]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>tcpdump -c 3 -nni eth2 arp</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">tcpdump: listening on eth2
06:02:50.626330 arp reply 192.168.99.35 is-at 0:80:c8:f8:4a:51 (0:80:c8:f8:4a:51) 
06:02:51.622727 arp reply 192.168.99.35 is-at 0:80:c8:f8:4a:51 (0:80:c8:f8:4a:51) 
06:02:52.620954 arp reply 192.168.99.35 is-at 0:80:c8:f8:4a:51 (0:80:c8:f8:4a:51)</code>
        </pre></td></tr></tbody></table></div><p>
        The frames generated in
        <a href="http://linux-ip.net/html/ether-arp.html#ex-ether-arp-gratuitous" title="Example 2.2. Gratuitous ARP reply frames">Example&nbsp;2.2, “Gratuitous ARP reply frames”</a> are ARP replies to a
        question never asked.  This sort of ARP is common in failover
        solutions and also for nefarious sorts of purposes, such as
        <a xmlns="http://www.w3.org/TR/xhtml1/transitional" class="nonlocal" href="http://ettercap.sourceforge.net/" target="_top"><span xmlns="http://www.w3.org/1999/xhtml"><strong class="command">ettercap</strong></span></a>.
      </p><p>
        Unsolicited ARP request frames, on the other hand, are broadcast
        ARP requests initiated by a host owning an IP address.
      </p><a id="id2540615" class="indexterm"></a><a id="id2540636" class="indexterm"></a><div class="example"><a id="ex-ether-arp-unsolicited"></a><p class="title"><b>Example&nbsp;2.3.&nbsp;Unsolicited ARP request frames</b></p><table xmlns="http://www.w3.org/TR/xhtml1/transitional" border="0" bgcolor="#E0E0E0" width="90%"><tbody><tr><td><pre class="programlisting"><code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@tristan]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>arping -q -c 3 -U -I eth0 192.168.99.35</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@masq-gw]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>tcpdump -c 3 -nni eth2 arp</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">tcpdump: listening on eth2
06:28:23.172068 arp who-has 192.168.99.35 (ff:ff:ff:ff:ff:ff) tell 192.168.99.35
06:28:24.167290 arp who-has 192.168.99.35 (ff:ff:ff:ff:ff:ff) tell 192.168.99.35
06:28:25.167250 arp who-has 192.168.99.35 (ff:ff:ff:ff:ff:ff) tell 192.168.99.35</code>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@masq-gw]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip neigh show</code></strong>
        </pre></td></tr></tbody></table></div><p>
        These two uses of <span><strong class="command">arping</strong></span> can help diagnose Ethernet
        and ARP problems--particularly hosts replying for addresses which do
        not belong to them.
      </p><p>
        To avoid IP address collisions on dynamic networks (where hosts are
        turning on and off, connecting and disconnecting and otherwise
        changing IP addresses) duplicate address detection becomes important.
        Fortunately, <span><strong class="command">arping</strong></span> provides this functionality as
        well.  A startup script could include the <span><strong class="command">arping</strong></span>
        utility in duplicate address detection mode to select between
        IP addresses or methods of acquiring an IP address.
      </p><a id="id2540748" class="indexterm"></a><a id="id2540765" class="indexterm"></a><div class="example"><a id="ex-ether-arp-dad"></a><p class="title"><b>Example&nbsp;2.4.&nbsp;Duplicate Address Detection with ARP</b></p><table xmlns="http://www.w3.org/TR/xhtml1/transitional" border="0" bgcolor="#E0E0E0" width="90%"><tbody><tr><td><pre class="programlisting"><code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@tristan]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>arping -D -I eth0 192.168.99.147; echo $?</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">ARPING 192.168.99.47 from 0.0.0.0 eth0
Unicast reply from 192.168.99.47 [00:80:C8:E8:1E:FC] for 192.168.99.47 [00:80:C8:E8:1E:FC] 0.702ms
Sent 1 probes (1 broadcast(s))
Received 1 response(s)
1</code>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@tristan]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>tcpdump -eqtnni eth2 arp</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">tcpdump: listening on eth2
0:80:c8:f8:4a:51 ff:ff:ff:ff:ff:ff 60: arp who-has 192.168.99.147 (ff:ff:ff:ff:ff:ff) tell 0.0.0.0
0:80:c8:e8:1e:fc 0:80:c8:f8:4a:51 42: arp reply 192.168.99.147 is-at 0:80:c8:e8:1e:fc (0:80:c8:e8:1e:fc)</code>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@masq-gw]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip neigh show</code></strong>
        </pre></td></tr></tbody></table></div><p>
        Address Resolution Protocol, which provides a method to connect
        physical network addresses with logical network addresses
        is a key element to the deployment of IP on Ethernet networks.  
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ether-arp-cache"></a>2.1.2.&nbsp;The ARP cache</h3></div></div></div><a id="id2540869" class="indexterm"></a><a id="id2540882" class="indexterm"></a><p>
        In simplest terms, an ARP cache is a stored mapping of IP addresses
        with link layer addresses.  An ARP cache obviates the need for an ARP
        request/reply conversation for each IP packet exchanged.  Naturally,
        this efficiency comes with a price.  Each host maintains its own ARP
        cache, which can become outdated when a host is replaced, or an IP
        address moves from one host to another.  The ARP cache is also known
        as the neighbor table.
      </p><p>
        To display the ARP cache, the venerable and cross-platform
        <span><strong class="command">arp</strong></span> admirably dispatches its duty.  As with many of
        the <span><strong class="command">iproute2</strong></span> tools, more information is available
        via <span><strong class="command">ip neighbor</strong></span> than with <span><strong class="command">arp</strong></span>.
        <a href="http://linux-ip.net/html/ether-arp.html#ex-ether-arp-cache" title="Example 2.5. ARP cache listings with arp and
          ip neighbor">Example&nbsp;2.5, “ARP cache listings with <span>arp</span> and
          <span>ip neighbor</span>”</a> below illustrates the differences
        in the output between the output of these two different tools.
      </p><a id="id2540948" class="indexterm"></a><div class="example"><a id="ex-ether-arp-cache"></a><p class="title"><b>Example&nbsp;2.5.&nbsp;ARP cache listings with <span>arp</span> and
          <span>ip neighbor</span></b></p><table xmlns="http://www.w3.org/TR/xhtml1/transitional" border="0" bgcolor="#E0E0E0" width="90%"><tbody><tr><td><pre class="programlisting"><code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@tristan]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>arp -na</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">? (192.168.99.7) at 00:80:C8:E8:1E:FC [ether] on eth0
? (192.168.99.254) at 00:80:C8:F8:5C:73 [ether] on eth0</code>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@tristan]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip neighbor show</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">192.168.99.7 dev eth0 lladdr 00:80:c8:e8:1e:fc nud reachable
192.168.99.254 dev eth0 lladdr 00:80:c8:f8:5c:73 nud reachable</code>
        </pre></td></tr></tbody></table></div><p>
        A major difference between the information reported by <span><strong class="command">ip
        neighbor</strong></span> and <span><strong class="command">arp</strong></span> is the state of the
        proxy ARP table.  The only way to list permanently advertised entries
        in the neighbor table (proxy ARP entries) is with the
        <span><strong class="command">arp</strong></span>.
      </p><a id="id2541050" class="indexterm"></a><a id="id2541069" class="indexterm"></a><a id="ether-arp-cache-expiry"></a><p>
        Entries in the ARP cache are periodically and automatically
        verified unless continually used.  Along with 
        <code class="filename">net/ipv4/neigh/$DEV/gc_stale_time</code>,
        there are a number of other parameters in
        <code class="filename">net/ipv4/neigh/$DEV</code> which control the
        expiration of entries in the ARP cache.
      </p><p>
        When a host is down or disconnected from the Ethernet, there is a
        period of time during which other hosts may have an ARP cache entry
        for the disconnected host.  Any other machine may display a neighbor
        table with the link layer address of the recently disconnected host.
        Because there is a recently known-good link layer address on which
        the IP was reachable, the entry will abide.  At
        <code class="filename">gc_stale_time</code> the state of the entry will change,
        reflecting the need to verify the reachability of the link layer
        address.  When the disconnected host fails to respond ARP requests,
        the neighbor table entry will be marked as
        <code class="constant">incomplete</code>
      </p><p>
        Here are a the possible states for entries in the neighbor table.
      </p><a id="id2541140" class="indexterm"></a><div class="table"><a id="tb-ether-arp-cache-states"></a><p class="title"><b>Table&nbsp;2.1.&nbsp;Active ARP cache entry states</b></p><table summary="Active ARP cache entry states" border="1"><colgroup><col><col></colgroup><thead><tr><th align="center">ARP cache entry state</th><th align="center">meaning</th><th align="center">action if used</th></tr></thead><tbody><tr><td align="center">permanent</td><td align="center">never expires; never verified</td><td align="center">reset use counter</td></tr><tr><td align="center">noarp</td><td align="center">normal expiration; never verified</td><td align="center">reset use counter</td></tr><tr><td align="center">reachable</td><td align="center">normal expiration</td><td align="center">reset use counter</td></tr><tr><td align="center">stale</td><td align="center">still usable; needs verification</td><td align="center">reset use counter; change state to delay</td></tr><tr><td align="center">delay</td><td align="center">schedule ARP request; needs verification</td><td align="center">reset use counter</td></tr><tr><td align="center">probe</td><td align="center">sending ARP request</td><td align="center">reset use counter</td></tr><tr><td align="center">incomplete</td><td align="center">first ARP request sent</td><td align="center">send ARP request</td></tr><tr><td align="center">failed</td><td align="center">no response received</td><td align="center">send ARP request</td></tr></tbody></table></div><p>
        To resume, a host (192.168.99.7) in <code class="systemitem">tristan</code>'s ARP cache on the
        <a href="http://linux-ip.net/html/ax-example-network.html" title="Appendix A. An Example Network and Description">example network</a> has just
        been disconnected.  There are a series of events which
        will occur as <code class="systemitem">tristan</code>'s ARP cache entry for 192.168.99.7 expires and
        gets scheduled for verification.  Imagine that the following commands
        are run to capture each of these states immediately before state
        change.
      </p><a id="id2541346" class="indexterm"></a><div class="example"><a id="ex-ether-arp-cache-timeout"></a><p class="title"><b>Example&nbsp;2.6.&nbsp;ARP cache timeout</b></p><table xmlns="http://www.w3.org/TR/xhtml1/transitional" border="0" bgcolor="#E0E0E0" width="90%"><tbody><tr><td><pre class="programlisting"><code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@tristan]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip neighbor show 192.168.99.7</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">192.168.99.7 dev eth0 lladdr 00:80:c8:e8:1e:fc nud reachable</code>     <a xmlns="http://www.w3.org/1999/xhtml" id="ex-eact-reachable" href="http://linux-ip.net/html/ether-arp.html#ex-eact-reachable-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/1.png" alt="1" border="0"></a>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@tristan]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip neighbor show 192.168.99.7</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">192.168.99.7 dev eth0 lladdr 00:80:c8:e8:1e:fc nud stale</code>         <a xmlns="http://www.w3.org/1999/xhtml" id="ex-eact-stale" href="http://linux-ip.net/html/ether-arp.html#ex-eact-stale-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/2.png" alt="2" border="0"></a>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@tristan]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip neighbor show 192.168.99.7</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">192.168.99.7 dev eth0 lladdr 00:80:c8:e8:1e:fc nud delay</code>         <a xmlns="http://www.w3.org/1999/xhtml" id="ex-eact-delay" href="http://linux-ip.net/html/ether-arp.html#ex-eact-delay-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/3.png" alt="3" border="0"></a>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@tristan]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip neighbor show 192.168.99.7</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">192.168.99.7 dev eth0 lladdr 00:80:c8:e8:1e:fc nud probe</code>         <a xmlns="http://www.w3.org/1999/xhtml" id="ex-eact-probe" href="http://linux-ip.net/html/ether-arp.html#ex-eact-probe-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/4.png" alt="4" border="0"></a>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@tristan]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip neighbor show 192.168.99.7</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">192.168.99.7 dev eth0  nud incomplete</code>                            <a xmlns="http://www.w3.org/1999/xhtml" id="ex-eact-incomplete" href="http://linux-ip.net/html/ether-arp.html#ex-eact-incomplete-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/5.png" alt="5" border="0"></a>
          </pre></td></tr></tbody></table><div class="calloutlist"><table border="0" summary="Callout list"><tbody><tr><td width="5%" valign="top" align="left"><a id="ex-eact-reachable-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eact-reachable"><img src="./2.1. Address Resolution Protocol (ARP)_files/1.png" alt="1" border="0"></a> </td><td valign="top" align="left">
                  Before the entry has expired for 192.168.99.7, but after the
                  host has been disconnected from the network.  During this
                  time, <code class="systemitem">tristan</code> will continue to send out Ethernet frames with
                  the destination frame address set to the link layer address
                  according to this entry.
                </td></tr><tr><td width="5%" valign="top" align="left"><a id="ex-eact-stale-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eact-stale"><img src="./2.1. Address Resolution Protocol (ARP)_files/2.png" alt="2" border="0"></a> </td><td valign="top" align="left">
                  It has been <code class="constant">gc_stale_time</code> seconds since
                  the entry has been verified, so the state has changed to
                  stale.
                </td></tr><tr><td width="5%" valign="top" align="left"><a id="ex-eact-delay-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eact-delay"><img src="./2.1. Address Resolution Protocol (ARP)_files/3.png" alt="3" border="0"></a> </td><td valign="top" align="left">
                  This entry in the neighbor table has been requested.
                  Because the entry was in a stale state, the link layer
                  address was used, but now the kernel needs to verify
                  the accuracy of the address.  The kernel will soon send
                  an ARP request for the destination IP address.
                </td></tr><tr><td width="5%" valign="top" align="left"><a id="ex-eact-probe-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eact-probe"><img src="./2.1. Address Resolution Protocol (ARP)_files/4.png" alt="4" border="0"></a> </td><td valign="top" align="left">
                  The kernel is actively performing address resolution for the
                  entry.  It will send a total of
                  <code class="constant">ucast_solicit</code> frames to the last known
                  link layer address to attempt to verify reachability of the
                  address.  Failing this, it will send
                  <code class="constant">mcast_solicit</code> broadcast frames before
                  altering the ARP cache state and returning an error to any
                  higher layer services.
                </td></tr><tr><td width="5%" valign="top" align="left"><a id="ex-eact-incomplete-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eact-incomplete"><img src="./2.1. Address Resolution Protocol (ARP)_files/5.png" alt="5" border="0"></a> </td><td valign="top" align="left">
                  After all attempts to reach the destination address have
                  failed, the entry will appear in the neighbor table in this
                  state.
                </td></tr></tbody></table></div></div><p>
        The remaining neighbor table flags are visible when initial ARP
        requests are made.  If no ARP cache entry exists for a requested
        destination IP, the kernel will generate
        <code class="constant">mcast_solicit</code> ARP requests until receiving an
        answer.  
        During this discovery period, the ARP cache
        entry will be listed in an <em class="emphasis">incomplete</em> state.  If
        the lookup does not succeed after the specified number of ARP
        requests, the ARP cache entry will be listed in a
        <em class="emphasis">failed</em> state.  If the lookup does succeed, the
        kernel enters the response into the ARP cache and resets the
        confirmation and update timers.
      </p><p>
        After receipt of a corresponding ARP reply, the kernel enters the
        response into the ARP cache and resets the confirmation and update
        timers.
      </p><p>
        For machines not using a static mapping for link layer and IP
        addresses, ARP provides on demand mappings.  The remainder of this
        section will cover the methods available under linux to control the
        address resolution protocol.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ether-arp-suppression"></a>2.1.3.&nbsp;ARP Suppression</h3></div></div></div><a id="id2541690" class="indexterm"></a><p>
        Complete ARP suppression is not difficult at all.  ARP suppression can
        be accomplished under linux on a per-interface basis by setting the
        noarp flag on any Ethernet interface.
        Disabling ARP will require static neighbor table mappings
        for all hosts wishing to exchange packets across the Ethernet.
      </p><p>
        To suppress ARP on an interface simply use <span><strong class="command">ip
        link set dev $DEV arp off</strong></span> as in
        <a href="http://linux-ip.net/html/tools-ip-link.html#ex-tools-ip-link-set" title="Example B.7. Using ip link set to change device flags">Example&nbsp;B.7, “Using <span>ip link set</span> to change device flags”</a>
        or <span><strong class="command">ifconfig $DEV -arp</strong></span> as in
        <a href="http://linux-ip.net/html/tools-ifconfig.html#ex-tools-ifconfig-flags" title="Example C.5. Setting interface flags with ifconfig">Example&nbsp;C.5, “Setting interface flags with <span>ifconfig</span>”</a>.  Complete ARP suppression
        will prevent the host from sending any ARP requests or responding with
        any ARP replies.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ether-arp-flux"></a>2.1.4.&nbsp;The ARP Flux Problem</h3></div></div></div><a id="id2541762" class="indexterm"></a><p>
        When a linux box is connected to a network segment with multiple
        network cards, a potential problem with the link layer address 
        to IP address mapping can occur.
        The machine may respond to ARP requests from both Ethernet interfaces.
        On the machine creating the ARP request, these multiple answers can
        cause confusion, or worse yet, non-deterministic population
        of the ARP cache.  Known as ARP flux
        <sup>[<a id="id2541784" href="http://linux-ip.net/html/ether-arp.html#ftn.id2541784">13</a>]</sup>,
        this can lead to the possibly puzzling effect that an IP migrates
        non-deterministically through multiple link layer addresses.  It's
        important to understand that ARP flux typically only affects hosts
        which have multiple physical connections to the same medium or
        broadcast domain.
      </p><p>
        This is a simple illustration of the problem in a network where a
        server has two Ethernet adapters connected to the same media
        segment.  They need not have IP addresses in the same IP network for
        the ARP reply to be generated by each interface.  Note the first
        two replies received in response to the ARP broadcast request.
        These replies arrive from conflicting link layer addresses in
        response to this request.  Also notice the greater time required for
        the sending and receiving hosts to process the broadcast ARP request
        frames than the unicast frames which follow (probes two and three).
      </p><div class="example"><a id="ex-ether-arp-flux"></a><p class="title"><b>Example&nbsp;2.7.&nbsp;ARP flux</b></p><table xmlns="http://www.w3.org/TR/xhtml1/transitional" border="0" bgcolor="#E0E0E0" width="90%"><tbody><tr><td><pre class="programlisting"><code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-client]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>arping -I eth0 -c 3 10.10.20.67</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">ARPING 10.10.20.67 from 10.10.20.33 eth0
Unicast reply from 10.10.20.67 [00:80:C8:7E:71:D4]  11.298ms
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  12.077ms
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  1.542ms
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  1.547ms
Sent 3 probes (1 broadcast(s))
Received 4 response(s)</code>
        </pre></td></tr></tbody></table></div><p>
        There are four solutions to this problem.  The common solution for
        kernel 2.4 harnesses the
        <a href="http://linux-ip.net/html/ether-arp.html#ether-arp-flux-arpfilter" title="2.1.4.1. ARP flux prevention with arp_filter"><code class="constant">arp_filter</code>
        sysctl</a>, while the common solution for kernel 2.2 takes
        advantage of the
        <a href="http://linux-ip.net/html/ether-arp.html#ether-arp-flux-hidden" title="2.1.4.2. ARP flux prevention with hidden"><code class="constant">hidden</code>
        sysctl</a>.  These two solutions alter the behaviour of ARP on a
        per interface basis and only if the functionality has been enabled.
      </p><p>
        Alternate solutions which provide much greater control of ARP
        (possibly documented
        <a href="http://linux-ip.net/html/ether-arp-filtering.html" title="2.3. ARP filtering">here</a> at a later date)
        include Julian Anastasov's
        <a xmlns="http://www.w3.org/TR/xhtml1/transitional" class="nonlocal" href="http://www.ssi.bg/~ja/#iparp" target="_top"><span xmlns="http://www.w3.org/1999/xhtml"><strong class="command">ip
        arp</strong></span></a> tool and his
        <a xmlns="http://www.w3.org/TR/xhtml1/transitional" class="nonlocal" href="http://www.ssi.bg/~ja/#noarp" target="_top">noarp
        route flag</a>.  While these tools were conceived in the course of
        the
        <a xmlns="http://www.w3.org/TR/xhtml1/transitional" class="nonlocal" href="http://www.linuxvirtualserver.org/" target="_top">Linux Virtual
        Server</a> project, they have practical application outside this
        realm.
      </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ether-arp-flux-arpfilter"></a>2.1.4.1.&nbsp;ARP flux prevention with <code class="constant">arp_filter</code></h4></div></div></div><a id="id2539787" class="indexterm"></a><a id="id2539801" class="indexterm"></a><p>
          One method for preventing ARP flux involves the use of
          <code class="filename">net/ipv4/conf/$DEV/arp_filter</code>.  In
          short, the use of <code class="filename">arp_filter</code> causes the recipient
          (in the
          <a href="http://linux-ip.net/html/ether-arp.html#ex-ether-arp-flux-arpfilter" title="Example 2.8. Correction of ARP flux with
            conf/$DEV/arp_filter">case below</a>,
          <code class="systemitem">real-server</code>) to perform a route lookup to
          determine the interface through which to send the
          reply, instead of the default behaviour
          (<a href="http://linux-ip.net/html/ether-arp.html#ex-ether-arp-flux" title="Example 2.7. ARP flux">shown above</a>), replying
          from all Ethernet interfaces which receive the request.
        </p><p>
          The <code class="filename">arp_filter</code> solution can have unintended
          effects if the only route to the destination
          is through one of the network cards.  In
          <a href="http://linux-ip.net/html/ether-arp.html#ex-ether-arp-flux-arpfilter" title="Example 2.8. Correction of ARP flux with
            conf/$DEV/arp_filter">Example&nbsp;2.8, “Correction of ARP flux with
            <code class="filename">conf/$DEV/arp_filter</code>”</a>, <code class="systemitem">real-client</code> will
          demonstrate this.  This instructive example should highlight
          the shortcomings of the <code class="constant">arp_filter</code> solution in
          very complex networks where finer-grained control is required.
        </p><p>
          In general, the <code class="filename">arp_filter</code> solution
          sufficiently solves the ARP flux problem.  First, hosts do not
          generate ARP requests for networks to which they do not have a
          direct route (see 
          <a href="http://linux-ip.net/html/routing-local.html" title="4.2. Routing to Locally Connected Networks">Section&nbsp;4.2, “Routing to Locally Connected Networks”</a>) and second, when such a route
          exists, the host normally
          <a href="http://linux-ip.net/html/routing-saddr-selection.html" title="4.6. Source Address Selection">chooses a source
          address</a> in the same network as the destination.  So, the
          <code class="filename">arp_filter</code> solution is a good general solution,
          but does not adequately address the occasional need for more control
          over ARP requests and replies.
        </p><div class="example"><a id="ex-ether-arp-flux-arpfilter"></a><p class="title"><b>Example&nbsp;2.8.&nbsp;Correction of ARP flux with
            <code class="filename">conf/$DEV/arp_filter</code></b></p><table xmlns="http://www.w3.org/TR/xhtml1/transitional" border="0" bgcolor="#E0E0E0" width="90%"><tbody><tr><td><pre class="programlisting"><code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-server]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_filter</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-server]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>echo 1 &gt; /proc/sys/net/ipv4/conf/eth0/arp_filter</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-server]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>echo 1 &gt; /proc/sys/net/ipv4/conf/eth1/arp_filter</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-server]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip address show dev eth0</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:e8:1e:fc brd ff:ff:ff:ff:ff:ff
    inet 10.10.20.67/24 scope global eth0</code>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-server]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip address show dev eth1</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">3: eth1: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:7e:71:d4 brd ff:ff:ff:ff:ff:ff
    inet 192.168.100.1/24 brd 192.168.100.255 scope global eth1</code>    <a xmlns="http://www.w3.org/1999/xhtml" id="ex-eafa-server-setup" href="http://linux-ip.net/html/ether-arp.html#ex-eafa-server-setup-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/1.png" alt="1" border="0"></a>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-client]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>arping -I eth0 -c 3 10.10.20.67</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">ARPING 10.10.20.67 from 10.10.20.33 eth0
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  0.882ms
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  1.221ms
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  1.487ms        </code><a xmlns="http://www.w3.org/1999/xhtml" id="ex-eafa-expected" href="http://linux-ip.net/html/ether-arp.html#ex-eafa-expected-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/2.png" alt="2" border="0"></a><code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">
Sent 3 probes (1 broadcast(s))
Received 3 response(s)</code>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-client]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>arping -I eth0 -c 3 192.168.100.1</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">ARPING 192.168.100.1 from 10.10.20.33 eth0
Unicast reply from 192.168.100.1 [00:80:C8:E8:1E:FC]  0.877ms
Unicast reply from 192.168.100.1 [00:80:C8:E8:1E:FC]  1.517ms
Unicast reply from 192.168.100.1 [00:80:C8:E8:1E:FC]  1.661ms      </code><a xmlns="http://www.w3.org/1999/xhtml" id="ex-eafa-problemzone" href="http://linux-ip.net/html/ether-arp.html#ex-eafa-problemzone-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/3.png" alt="3" border="0"></a><code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">
Sent 3 probes (1 broadcast(s))
Received 3 response(s)</code>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-client]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip neighbor del 192.168.100.1 dev eth0</code></strong>         <a xmlns="http://www.w3.org/1999/xhtml" id="ex-eafa-clearcache" href="http://linux-ip.net/html/ether-arp.html#ex-eafa-clearcache-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/4.png" alt="4" border="0"></a>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-client]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>ip address add 192.168.100.2/24 brd + dev eth0</code></strong> <a xmlns="http://www.w3.org/1999/xhtml" id="ex-eafa-newip" href="http://linux-ip.net/html/ether-arp.html#ex-eafa-newip-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/5.png" alt="5" border="0"></a>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-client]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>arping -I eth0 -c 3 192.168.100.1</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">ARPING 192.168.100.1 from 192.168.100.2 eth0
Unicast reply from 192.168.100.1 [00:80:C8:7E:71:D4]  0.804ms
Unicast reply from 192.168.100.1 [00:80:C8:7E:71:D4]  1.381ms
Unicast reply from 192.168.100.1 [00:80:C8:7E:71:D4]  2.487ms      </code><a xmlns="http://www.w3.org/1999/xhtml" id="ex-eafa-workaround" href="http://linux-ip.net/html/ether-arp.html#ex-eafa-workaround-text"><img src="./2.1. Address Resolution Protocol (ARP)_files/6.png" alt="6" border="0"></a><code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">
Sent 3 probes (1 broadcast(s))
Received 3 response(s)</code>
          </pre></td></tr></tbody></table><div class="calloutlist"><table border="0" summary="Callout list"><tbody><tr><td width="5%" valign="top" align="left"><a id="ex-eafa-server-setup-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eafa-server-setup"><img src="./2.1. Address Resolution Protocol (ARP)_files/1.png" alt="1" border="0"></a> </td><td valign="top" align="left">
                  Set the sysctl variables to enable the
                  <code class="filename">arp_filter</code> functionality.  After this,
                  you might expect that ARP replies for 10.10.20.67 would only
                  advertise the link layer address on eth0 (00:80:c8:e8:1e:fc).
                </td></tr><tr><td width="5%" valign="top" align="left"><a id="ex-eafa-expected-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eafa-expected"><img src="./2.1. Address Resolution Protocol (ARP)_files/2.png" alt="2" border="0"></a> </td><td valign="top" align="left">
                  Here is the expected behaviour.  Only one reply comes in for
                  the IP 10.10.20.67 after the <code class="filename">arp_filter</code>
                  sysctl has been enabled.  The reply originates from the
                  interface on <code class="systemitem">real-server</code> which actually hosts the IP
                  address.  Note that the source address on the ARP queries is
                  10.10.20.33, and that the ARP query causes <code class="systemitem">real-server</code> to
                  perform a route lookup on 10.10.20.33 to choose an interface
                  from which to send the reply.
                </td></tr><tr><td width="5%" valign="top" align="left"><a id="ex-eafa-problemzone-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eafa-problemzone"><img src="./2.1. Address Resolution Protocol (ARP)_files/3.png" alt="3" border="0"></a> </td><td valign="top" align="left">
                  Here, <code class="systemitem">real-client</code> requests the link layer address of the
                  host 192.168.100.1, but the source IP on the request packet
                  (chosen according to the
                  <a href="http://linux-ip.net/html/routing-saddr-selection.html" title="4.6. Source Address Selection">rules for source
                  address selection</a>) is 10.10.20.33.  When
                  <code class="systemitem">real-server</code> looks up a route to this destination, it
                  chooses its eth0, and replies with the link layer address of
                  its eth0.  Conventional networking needs should not run
                  afoul of this oddity of the <code class="filename">arp_filter</code>
                  ARP flux prevention technique.
                </td></tr><tr><td width="5%" valign="top" align="left"><a id="ex-eafa-clearcache-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eafa-clearcache"><img src="./2.1. Address Resolution Protocol (ARP)_files/4.png" alt="4" border="0"></a> </td><td valign="top" align="left">
                  Remove the entry in the neighbor table before testing again.
                </td></tr><tr><td width="5%" valign="top" align="left"><a id="ex-eafa-newip-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eafa-newip"><img src="./2.1. Address Resolution Protocol (ARP)_files/5.png" alt="5" border="0"></a> </td><td valign="top" align="left">
                  By adding an IP address in the same network as the intended
                  destination (which would be
                  rather common where multiple IP networks share the same
                  medium or broadcast domain), the kernel can now select a
                  different source address for the ARP request packets.
                </td></tr><tr><td width="5%" valign="top" align="left"><a id="ex-eafa-workaround-text"></a><a href="http://linux-ip.net/html/ether-arp.html#ex-eafa-workaround"><img src="./2.1. Address Resolution Protocol (ARP)_files/6.png" alt="6" border="0"></a> </td><td valign="top" align="left">
                  Note the source address of the ARP queries is now
                  192.168.100.2.  When <code class="systemitem">real-server</code> performs a route lookup
                  for the 192.168.100.0/24 destination, the chosen path is
                  through eth1.  The ARP reply packets now have the correct
                  link layer address.
                </td></tr></tbody></table></div></div><p>
          In general, the <code class="filename">arp_filter</code> solution should
          suffice, but this knowledge can be key in determining whether or not
          an alternate solution, such as an
          <a href="http://linux-ip.net/html/ether-arp-filtering.html" title="2.3. ARP filtering">ARP filtering solution</a>
          are necessary.
        </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="ether-arp-flux-hidden"></a>2.1.4.2.&nbsp;ARP flux prevention with <code class="constant">hidden</code></h4></div></div></div><a id="id2542732" class="indexterm"></a><a id="id2542749" class="indexterm"></a><p>
          The ARP flux problem can also be combatted with a
          <a xmlns="http://www.w3.org/TR/xhtml1/transitional" class="nonlocal" href="http://www.ssi.bg/~ja/#hidden" target="_top">kernel
          patch</a> by Julian Anastasov, which was incorporated into the
          2.2.14+ kernel series, but never into the 2.4+ kernel series.
          Therefore, the functionality may not be available in all
          kernels.
        </p><p>
          The sysctl <code class="filename">net/ipv4/conf/$DEV/hidden</code> toggles
          the generation of ARP replies for requested IPs.  It marks an
          interface and all of its IP addresses invisible to other
          interfaces for the purpose of ARP
          requests.  When an ARP request arrives on any interface, the kernel
          tests to see if the IP address is locally hosted anywhere on the
          machine.  If the IP is found on any interface, the kernel will
          generate a reply.
        </p><p>
          Since this is not always desirable, the <code class="filename">hidden</code>
          sysctl can be employed.  This prevents the kernel from finding the
          IP address when testing to see what IP addresses are locally hosted.
          The kernel can always find IPs hosted on the interface on which the
          packet arrived, but it cannot find addresses which are
          <code class="filename">hidden</code>.
        </p><p>
          As shown in
          <a href="http://linux-ip.net/html/ether-arp.html#ex-ether-arp-flux-hidden" title="Example 2.9. Correction of ARP flux with
            net/$DEV/hidden">Example&nbsp;2.9, “Correction of ARP flux with
            <code class="filename">net/$DEV/hidden</code>”</a>, not only can ARP flux be
          corrected, but sensitive information about the IP addresses
          available on a linux box can be safeguarded
          <sup>[<a id="id2542834" href="http://linux-ip.net/html/ether-arp.html#ftn.id2542834">14</a>]</sup>.
          This makes the <code class="filename">hidden</code> sysctl useful for
          preventing unwanted IP disclosure via ARP on multi-homed hosts,
          in addition to preventing ARP flux on hosts connected to the
          same network medium.
        </p><div class="example"><a id="ex-ether-arp-flux-hidden"></a><p class="title"><b>Example&nbsp;2.9.&nbsp;Correction of ARP flux with
            <code class="filename">net/$DEV/hidden</code></b></p><table xmlns="http://www.w3.org/TR/xhtml1/transitional" border="0" bgcolor="#E0E0E0" width="90%"><tbody><tr><td><pre class="programlisting"><code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-client]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>arping -I eth0 -c 1 172.19.22.254</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">ARPING 172.19.22.254 from 172.19.22.2 eth0
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2D]  0.704ms
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2E]  0.844ms
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2F]  0.918ms
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2C]  0.974ms
Sent 1 probes (1 broadcast(s))
Received 4 response(s)</code>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-server]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>for i in all eth2 eth3 eth4 eth5 ; do</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">&gt; </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>echo 1 &gt; /proc/sys/net/ipv4/conf/$i/hidden</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">&gt; </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>done</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="prompt">[root@real-client]# </code><strong xmlns="http://www.w3.org/1999/xhtml" class="userinput"><code>arping -I eth0 -c 2 172.19.22.254</code></strong>
<code xmlns="http://www.w3.org/1999/xhtml" class="computeroutput">ARPING 172.19.22.254 from 172.19.22.2 eth0
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2D]  0.710ms
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2D]  0.624ms
Sent 2 probes (1 broadcast(s))
Received 2 response(s)</code>
          </pre></td></tr></tbody></table></div><p>
          These are two examples of methods to prevent ARP flux.  Other
          alternatives for correcting this problem are documented in
          <a href="http://linux-ip.net/html/ether-arp-filtering.html" title="2.3. ARP filtering">Section&nbsp;2.3, “ARP filtering”</a>, where much more sophisticated
          tools are available for manipulation and control over the ARP
          functions of linux.
        </p></div></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a id="ftn.id2539996" href="http://linux-ip.net/html/ether-arp.html#id2539996">9</a>] </sup>
              Some networking equipment vendors have built devices which are
              sold as high performance switches and are capable of performing
              operations on higher layer contents of Ethernet frames.
              Typically, however, a switching device is not capable of
              operating on IP packets.
            </p></div><div class="footnote"><p><sup>[<a id="ftn.id2540041" href="http://linux-ip.net/html/ether-arp.html#id2540041">10</a>] </sup>
            The kernel uses the Ethernet broadcast address configured on the
            link layer device.  This is rarely anything but ff:ff:ff:ff:ff:ff.
            In the extraordinary event that this is not the Ethernet broadcast
            address in your network, see
            <a href="http://linux-ip.net/html/tools-ip-link.html#tools-ip-link-set-address" title="B.3.7. Changing hardware or Ethernet broadcast address with
          ip link set">Section&nbsp;B.3.7, “Changing hardware or Ethernet broadcast address with
          <span><strong class="command">ip link set</strong></span>”</a>.
          </p></div><div class="footnote"><p><sup>[<a id="ftn.id2540227" href="http://linux-ip.net/html/ether-arp.html#id2540227">11</a>] </sup>
              <span><strong class="command">tcpdump</strong></span> is one of a number of utilities for
              watching packets visible to an interface.  For further
              introduction to <span><strong class="command">tcpdump</strong></span>, see
              <a href="http://linux-ip.net/html/tools-tcpdump.html" title="G.5. tcpdump">Section&nbsp;G.5, “<span><strong class="command">tcpdump</strong></span>”</a>.
            </p></div><div class="footnote"><p><sup>[<a id="ftn.id2540481" href="http://linux-ip.net/html/ether-arp.html#id2540481">12</a>] </sup>
            I have repeatedly tested using <span><strong class="command">arping</strong></span> in
            gratuitous ARP mode, and have found that linux kernels appear to
            respect gratuitous ARP.  This is a surprise.  Does anybody have
            ideas about this?  Must research!
          </p></div><div class="footnote"><p><sup>[<a id="ftn.id2541784" href="http://linux-ip.net/html/ether-arp.html#id2541784">13</a>] </sup>
            I have seen it called names other than ARP flux--anybody out there
            heard of this called anything besides ARP flux?
          </p></div><div class="footnote"><p><sup>[<a id="ftn.id2542834" href="http://linux-ip.net/html/ether-arp.html#id2542834">14</a>] </sup>
              Consider a masquerading firewall which answers ARP requests on a
              public segment for IPs hosted on an internal interface.  This
              amounts to inadvertent exposure of internal addressing, and can be
              used by an attacker as part of a data-gathering or reconaissance
              operation on a network.
            </p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tbody><tr><td width="40%" align="left"><a accesskey="p" href="http://linux-ip.net/html/ch-ether.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="http://linux-ip.net/html/ch-ether.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="http://linux-ip.net/html/ether-arp-proxy.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;2.&nbsp;Ethernet&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="http://linux-ip.net/html/index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;2.2.&nbsp;Proxy ARP</td></tr></tbody></table></div>
</body></html>